{% extends "base.html" %}
{% block content %}
<div class="flex min-h-screen bg-gray-50">
    <!-- Sidebar -->
    <aside class="w-64 bg-slate-900 text-white px-4 py-6 border-r fixed h-screen overflow-y-auto">
        <!-- Branding -->
        <div class="mb-6">
            <h1 class="text-2xl font-bold text-white">Course Dashboard</h1>
            <p class="text-sm text-slate-400">Manage your courses efficiently</p>
        </div>

        <!-- Navigation -->
        <div x-data="{ 
            openCourse: {% if request.resolver_match.url_name == 'course-list' or request.resolver_match.url_name == 'create-courses' %}true{% else %}false{% endif %}, 
            openTeacher: {% if request.resolver_match.url_name == 'teacher-list' %}true{% else %}false{% endif %}, 
            openSchedule: {% if request.resolver_match.url_name == 'schedule-list' or request.resolver_match.url_name == 'manage-schedule' %}true{% else %}false{% endif %},
            openAnalytics: {% if request.resolver_match.url_name == 'analysis-list' or request.resolver_match.url_name == 'create-analysis' %}true{% else %}false{% endif %}
        }">
            <!-- Courses Dropdown -->
            <div>
                <button @click="openCourse = !openCourse"
                    class="w-full text-left p-2 font-semibold hover:bg-slate-800 rounded">
                    Courses
                </button>
                <ul x-show="openCourse" class="ml-4 space-y-1">
                    <li>
                        <a href="{% url 'course-list' %}"
                            class="block p-2 {% if request.resolver_match.url_name == 'course-list' %}font-bold{% else %}hover:font-bold{% endif %}">
                            List
                        </a>
                    </li>
                    {% if user_settings and user_settings.role == 'manager' %}
                    <li>
                        <a href="{% url 'create-courses' %}"
                            class="block p-2 {% if request.resolver_match.url_name == 'create-courses' %}font-bold{% else %}hover:font-bold{% endif %}">
                            Create
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </div>

            <!-- Teachers Dropdown -->
            <div>
                <button @click="openTeacher = !openTeacher"
                    class="w-full text-left p-2 font-semibold hover:bg-slate-800 rounded">
                    Teachers
                </button>
                <ul x-show="openTeacher" class="ml-4 space-y-1">
                    <li>
                        <a href="{% url 'teacher-list' %}"
                            class="block p-2 {% if request.resolver_match.url_name == 'teacher-list' %}font-bold{% else %}hover:font-bold{% endif %}">
                            List
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Schedules Dropdown -->
            <div>
                <button @click="openSchedule = !openSchedule"
                    class="w-full text-left p-2 font-semibold hover:bg-slate-800 rounded">
                    Schedules
                </button>
                <ul x-show="openSchedule" class="ml-4 space-y-1">
                    <li>
                        <a href="{% url 'schedule-list' %}"
                            class="block p-2 {% if request.resolver_match.url_name == 'schedule-list' %}font-bold{% else %}hover:font-bold{% endif %}">
                            List
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Analytics Dropdown -->
            <div>
                <button @click="openAnalytics = !openAnalytics"
                    class="w-full text-left p-2 font-semibold hover:bg-slate-800 rounded cursor-pointer">
                    Analytics
                </button>
                <ul x-show="openAnalytics" class="ml-4 space-y-1">
                    <li>
                        <a href="{% url 'analysis-list' %}"
                            class="block p-2 {% if request.resolver_match.url_name == 'analysis-list' %}font-bold{% else %}hover:font-bold{% endif %}">
                            List
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Logout -->
            <div class="mt-4">
                <a href="{% url 'logout' %}"
                    class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded w-full block text-left cursor-pointer">
                    Logout
                </a>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-6 ml-64">
        {% block dashboard_content %}
        <!-- Extendable content goes here -->
        {% endblock dashboard_content %}

        <!-- MCP Chat Interface -->
        <div x-data="mcpChat()" class="fixed bottom-6 right-6 z-50">
            <!-- Chat Button -->
            <button @click="isOpen = !isOpen"
                class="bg-slate-900 text-white p-4 rounded-full shadow-lg hover:bg-slate-800 hover:scale-110 focus:outline-none transition-all duration-200 cursor-pointer relative z-50">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z">
                    </path>
                </svg>
            </button>

            <!-- Chat Window -->
            <div x-show="isOpen" 
                @click="isOpen = false"
                x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0 transform translate-y-4"
                x-transition:enter-end="opacity-100 transform translate-y-0"
                x-transition:leave="transition ease-in duration-200"
                x-transition:leave-start="opacity-100 transform translate-y-0"
                x-transition:leave-end="opacity-0 transform translate-y-4"
                class="fixed inset-0 mx-auto flex items-start justify-end p-4 bg-black/10 backdrop-blur-sm z-40">
                <div @click.stop
                    class="w-[480px] h-[90vh] bg-white rounded-xl shadow-[0_8px_30px_rgb(0,0,0,0.12)] flex flex-col overflow-hidden mr-20">
                    <!-- Header -->
                    <div class="px-6 py-4 border-b bg-slate-900 text-white flex justify-between items-center">
                        <h3 class="text-lg font-semibold">AI Assistant</h3>
                        <button @click="isOpen = false" class="cursor-pointer text-gray-400 hover:text-white">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Messages -->
                    <div class="flex-1 overflow-y-auto p-6" id="chat-messages">
                        <template x-for="(message, index) in messages" :key="index">
                            <div class="mb-4">
                                <div class="flex items-start space-x-4">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-semibold"
                                            :class="{'bg-slate-900': message.type === 'system', 'bg-blue-600': message.type === 'user'}">
                                            <span x-text="message.type === 'system' ? 'AI' : 'You'"></span>
                                        </div>
                                    </div>
                                    <div class="flex-1">
                                        <p class="rounded-lg p-4" 
                                            :class="{'bg-gray-100': message.type === 'system', 'bg-blue-50': message.type === 'user'}"
                                            x-text="message.content"></p>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- Input -->
                    <div class="p-4 border-t bg-gray-50">
                        <form @submit.prevent="sendPrompt(currentParentId)" class="flex gap-3">
                            {% csrf_token %}
                            <input type="text" x-model="prompt" placeholder="Type your response..."
                                :class="{'border-blue-500 ring-1 ring-blue-500': currentParentId}"
                                class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-slate-900 focus:ring-1 focus:ring-slate-900">
                            <button type="submit"
                                class="bg-slate-900 text-white px-6 py-2 rounded-lg hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-slate-900 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                :disabled="isProcessing">
                                <span x-show="!isProcessing" x-text="currentParentId ? 'Reply' : 'Send'"></span>
                                <span x-show="isProcessing">Processing...</span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
    function mcpChat() {
        return {
            isOpen: false,
            prompt: '',
            response: '',
            isProcessing: false,
            conversationId: null,
            messages: [],
            currentParentId: null,

            async sendPrompt(parentId = null) {
                if (!this.prompt || this.isProcessing) return;

                this.messages.push({
                    type: 'user',
                    content: this.prompt
                });

                this.isProcessing = true;
                try {
                    const formData = new FormData();
                    formData.append('prompt', this.prompt);
                    if (parentId) {
                        formData.append('parent_id', parentId);
                    }

                    const response = await fetch('/mcp/conversation/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: formData
                    });
                    const data = await response.json();
                    this.conversationId = data.id;
                    this.pollResponse();
                } catch (error) {
                    console.error('Error:', error);
                    this.addSystemMessage('An error occurred while processing your request.');
                    this.isProcessing = false;
                }

                this.prompt = '';
            },

            addSystemMessage(content) {
                this.messages.push({
                    type: 'system',
                    content: content
                });
                // Auto scroll to bottom
                this.$nextTick(() => {
                    const chatMessages = document.getElementById('chat-messages');
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                });
            },

            async pollResponse() {
                if (!this.conversationId) return;

                const checkStatus = async () => {
                    try {
                        const response = await fetch(`/mcp/conversation/${this.conversationId}/status/`);
                        const data = await response.json();

                        if (data.status === 'completed') {
                            this.addSystemMessage(data.response);
                            this.isProcessing = false;
                            this.currentParentId = null;
                            return true;
                        } else if (data.status === 'awaiting_input') {
                            this.addSystemMessage(data.response);
                            this.isProcessing = false;
                            this.currentParentId = this.conversationId;
                            return true;
                        } else if (data.status === 'failed') {
                            this.addSystemMessage('Failed to process your request: ' + (data.error || 'Unknown error'));
                            this.isProcessing = false;
                            this.currentParentId = null;
                            return true;
                        }
                        return false;
                    } catch (error) {
                        console.error('Error:', error);
                        this.addSystemMessage('An error occurred while checking status.');
                        this.isProcessing = false;
                        return true;
                    }
                };

                while (!(await checkStatus())) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
        }
    }
</script>
{% endblock content %}