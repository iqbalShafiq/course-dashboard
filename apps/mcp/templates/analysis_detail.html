{% extends "dashboard_base.html" %}
{% block title %}Analysis Results{% endblock %}

{% block dashboard_content %}
{{ analysis.result|json_script:"analysis-data" }}
<div class="container mx-auto px-4" x-data="analysisDetail(JSON.parse(document.getElementById('analysis-data').textContent))">
    <div class="mb-6">
        <a href="{% url 'analysis-list' %}" class="text-slate-600 hover:text-slate-900 cursor-pointer">‚Üê Back to Analytics</a>
        <h1 class="text-2xl font-bold text-slate-900 mt-2">{{ analysis.title }}</h1>
        {% if analysis.description %}
        <p class="text-slate-600 mt-2">{{ analysis.description }}</p>
        {% endif %}
    </div>

    <!-- Visualization Section -->
    <div class="bg-white p-6 rounded-lg shadow-md border border-slate-900/10"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform translate-y-4"
         x-transition:enter-end="opacity-100 transform translate-y-0">
        <!-- Chart/Table Container -->
        <div class="mb-6">
            <template x-if="result && ['line', 'bar', 'pie'].includes('{{ analysis.visualization_type }}')">
                <div class="transition-all duration-300 ease-in-out"
                     x-transition:enter="transition ease-out duration-300"
                     x-transition:enter-start="opacity-0 scale-95"
                     x-transition:enter-end="opacity-100 scale-100">
                    <canvas id="chartCanvas"></canvas>
                </div>
            </template>

            <template x-if="result && result.raw_data && result.raw_data.length > 0 && '{{ analysis.visualization_type }}' === 'table'">
                <div class="overflow-x-auto transition-all duration-300 ease-in-out"
                     x-transition:enter="transition ease-out duration-300"
                     x-transition:enter-start="opacity-0 transform translate-y-4"
                     x-transition:enter-end="opacity-100 transform translate-y-0">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <template x-for="column in Object.keys(result.raw_data[0])" :key="column">
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider cursor-default" 
                                        x-text="column"></th>
                                </template>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-slate-200">
                            <template x-for="row in result.raw_data" :key="row.id || Math.random()">
                                <tr class="hover:bg-slate-50 cursor-default">
                                    <template x-for="column in Object.keys(result.raw_data[0])" :key="column">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900" 
                                            x-text="row[column]"></td>
                                    </template>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </template>

            <!-- Debug info -->
            <template x-if="result && result.raw_data && '{{ analysis.visualization_type }}' === 'table'">
                <div class="mt-4 p-4 bg-gray-50 rounded text-sm">
                    <p class="font-mono">Data rows: <span x-text="result.raw_data.length"></span></p>
                    <p class="font-mono">First row keys: <span x-text="result.raw_data[0] ? Object.keys(result.raw_data[0]).join(', ') : 'No data'"></span></p>
                </div>
            </template>

            <template x-if="result && '{{ analysis.visualization_type }}' === 'metric'">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4"
                     x-transition:enter="transition ease-out duration-300"
                     x-transition:enter-start="opacity-0 transform translate-y-4"
                     x-transition:enter-end="opacity-100 transform translate-y-0">
                    <template x-for="(value, key) in result.metadata" :key="key">
                        <div class="bg-slate-50 p-4 rounded-lg transform transition-all duration-300 hover:scale-105">
                            <div class="text-sm font-medium text-slate-500" x-text="key"></div>
                            <div class="mt-1 text-2xl font-semibold text-slate-900" x-text="value"></div>
                        </div>
                    </template>
                </div>
            </template>
        </div>

        <!-- Summary Section -->
        <div class="mt-6 p-4 bg-slate-50 rounded-lg transition-all duration-300 hover:shadow-md"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100">
            <h3 class="font-semibold text-slate-900 mb-2">Analysis Summary</h3>
            <p class="text-slate-600" x-text="result?.summary || 'No summary available'"></p>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function analysisDetail(initialResult) {
    return {
        result: initialResult,
        chart: null,

        init() {
            if (!this.result) return;
            if (!['line', 'bar', 'pie'].includes('{{ analysis.visualization_type }}')) return;

            const ctx = document.getElementById('chartCanvas');
            
            // Transform raw_data for chart if available
            let chartData = [];
            let chartLabels = [];
            
            if (this.result.raw_data && this.result.raw_data.length > 0) {
                // Get the first and second columns for chart data
                const keys = Object.keys(this.result.raw_data[0]);
                if (keys.length >= 2) {
                    chartLabels = this.result.raw_data.map(item => item[keys[0]]);
                    chartData = this.result.raw_data.map(item => item[keys[1]]);
                }
            }

            const config = {
                type: '{{ analysis.visualization_type }}',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: '{{ analysis.title }}',
                        data: chartData,
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.5)',
                            'rgba(16, 185, 129, 0.5)',
                            'rgba(239, 68, 68, 0.5)',
                            'rgba(217, 119, 6, 0.5)',
                        ],
                        borderColor: [
                            'rgb(59, 130, 246)',
                            'rgb(16, 185, 129)',
                            'rgb(239, 68, 68)',
                            'rgb(217, 119, 6)',
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: '{{ analysis.title }}'
                        }
                    }
                }
            };

            this.chart = new Chart(ctx, config);
        }
    }
}
</script>
{% endblock %}